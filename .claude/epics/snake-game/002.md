---
name: Core Game Loop & State Management
status: open
created: 2025-11-15T16:20:35Z
updated: 2025-11-15T16:20:35Z
github: null
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: Core Game Loop & State Management

## Description
Implement the core game loop using requestAnimationFrame with fixed time-step logic for consistent gameplay across different devices. Create the state machine to manage game states (START, PLAYING, PAUSED, GAME_OVER) with proper state transitions. This establishes the foundation for all game logic and rendering.

## Acceptance Criteria
- [ ] requestAnimationFrame-based game loop implemented
- [ ] Fixed time-step logic ensures consistent updates (not frame-dependent)
- [ ] State machine with four states: START, PLAYING, PAUSED, GAME_OVER
- [ ] State transition logic validates and handles state changes
- [ ] Update and render functions separated and called appropriately
- [ ] Game loop maintains target frame rate (60fps)
- [ ] Delta time calculated correctly between frames
- [ ] Game can be paused and resumed without issues

## Technical Details

**Game Loop Implementation:**
```javascript
const FPS = 60;
const FRAME_DURATION = 1000 / FPS;
const GAME_SPEED = 150; // ms per game tick

let lastFrameTime = 0;
let accumulator = 0;

function gameLoop(currentTime) {
  requestAnimationFrame(gameLoop);

  const deltaTime = currentTime - lastFrameTime;
  lastFrameTime = currentTime;

  accumulator += deltaTime;

  // Fixed time-step updates
  while (accumulator >= GAME_SPEED) {
    update(); // Game logic update
    accumulator -= GAME_SPEED;
  }

  render(); // Render current state
}
```

**State Machine Pattern:**
```javascript
const GameStates = {
  START: 'start',
  PLAYING: 'playing',
  PAUSED: 'paused',
  GAME_OVER: 'gameOver'
};

const stateManager = {
  currentState: GameStates.START,

  transition(newState) {
    // Validate transition
    if (this.isValidTransition(newState)) {
      this.onExit(this.currentState);
      this.currentState = newState;
      this.onEnter(newState);
    }
  },

  isValidTransition(newState) {
    // Define valid state transitions
  },

  onEnter(state) {
    // State initialization logic
  },

  onExit(state) {
    // State cleanup logic
  }
};
```

**Update Function Structure:**
```javascript
function update() {
  switch (stateManager.currentState) {
    case GameStates.PLAYING:
      updateGameLogic();
      break;
    case GameStates.PAUSED:
      // No updates while paused
      break;
    // Other states...
  }
}
```

**Render Function Structure:**
```javascript
function render() {
  clearCanvas();

  switch (stateManager.currentState) {
    case GameStates.START:
      renderStartScreen();
      break;
    case GameStates.PLAYING:
      renderGame();
      break;
    case GameStates.PAUSED:
      renderGame();
      renderPauseOverlay();
      break;
    case GameStates.GAME_OVER:
      renderGameOverScreen();
      break;
  }
}
```

**Code Locations:**
- `game.js`: Main game loop, state machine, update/render functions

**Key Considerations:**
- Decouple game logic updates from rendering
- Use accumulator pattern to handle variable frame times
- Ensure state transitions are clean and don't cause glitches
- Prevent browser from throttling requestAnimationFrame (visibility)
- Consider edge cases (rapid state transitions, browser tab switching)

## Dependencies
- [ ] Task 001 completed (project structure and canvas setup)

## Effort Estimate
- **Size:** M
- **Hours:** 10-12 hours
- **Parallel:** false (required for all game logic tasks)

## Definition of Done
- [ ] Game loop runs smoothly at 60fps
- [ ] Fixed time-step update logic implemented and tested
- [ ] All four game states defined and functional
- [ ] State transitions work correctly without errors
- [ ] Update and render functions separated properly
- [ ] No performance issues or jank observed
- [ ] Can transition between all states (start, play, pause, game over)
- [ ] Code is well-commented explaining game loop architecture
- [ ] DevTools Performance tab shows consistent frame timing
