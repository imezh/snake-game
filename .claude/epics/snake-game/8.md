---
name: Leaderboard System
status: open
created: 2025-11-15T16:20:35Z
updated: 2025-11-15T16:47:41Z
github: https://github.com/imezh/snake-game/issues/8
depends_on: [7]
parallel: false
conflicts_with: []
---

# Task: Leaderboard System

## Description
Implement local leaderboard using browser localStorage to persist top 10 scores. Create leaderboard modal UI that can be accessed from start screen and game over screen. Include functionality to save scores, retrieve sorted leaderboard, and clear leaderboard data.

## Acceptance Criteria
- [ ] localStorage integration for leaderboard persistence
- [ ] Leaderboard stores top 10 scores only
- [ ] Each entry includes score and date/time
- [ ] New scores automatically inserted in sorted order
- [ ] Leaderboard accessible from start screen (L key)
- [ ] Leaderboard accessible from game over screen (L key)
- [ ] Leaderboard displays in modal/overlay format
- [ ] Leaderboard shows rank, score, and date for each entry
- [ ] Clear leaderboard option with confirmation prompt
- [ ] Leaderboard modal can be closed (ESC or C key)
- [ ] High score shown on start screen updates from leaderboard

## Technical Details

**localStorage Schema:**
```javascript
const LEADERBOARD_KEY = 'snake_leaderboard';

// Structure:
// [{score: 150, date: '2025-11-15T16:00:00Z'}, ...]
```

**Leaderboard Functions:**
```javascript
function getLeaderboard() {
  const data = localStorage.getItem(LEADERBOARD_KEY);
  if (!data) return [];

  try {
    return JSON.parse(data);
  } catch (e) {
    console.error('Error parsing leaderboard:', e);
    return [];
  }
}

function saveScore(score) {
  if (score === 0) return; // Don't save zero scores

  const leaderboard = getLeaderboard();

  // Add new entry
  const entry = {
    score: score,
    date: new Date().toISOString()
  };

  leaderboard.push(entry);

  // Sort by score (descending)
  leaderboard.sort((a, b) => b.score - a.score);

  // Keep top 10 only
  const top10 = leaderboard.slice(0, 10);

  // Save to localStorage
  try {
    localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(top10));
  } catch (e) {
    console.error('Error saving leaderboard:', e);
    // Handle quota exceeded or localStorage disabled
  }
}

function getHighScore() {
  const leaderboard = getLeaderboard();
  return leaderboard.length > 0 ? leaderboard[0].score : 0;
}

function isTopScore(score) {
  const leaderboard = getLeaderboard();
  if (leaderboard.length < 10) return true;
  return score > leaderboard[leaderboard.length - 1].score;
}

function clearLeaderboard() {
  if (confirm('Are you sure you want to clear the leaderboard? This cannot be undone.')) {
    localStorage.removeItem(LEADERBOARD_KEY);
    return true;
  }
  return false;
}
```

**Leaderboard Modal Rendering:**
```javascript
let showingLeaderboard = false;

function renderLeaderboardModal() {
  // Semi-transparent overlay
  ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Title
  ctx.fillStyle = COLORS.text;
  ctx.font = 'bold 32px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('LEADERBOARD', canvas.width / 2, 60);

  // Get leaderboard data
  const leaderboard = getLeaderboard();

  if (leaderboard.length === 0) {
    ctx.font = '18px monospace';
    ctx.fillText('No scores yet!', canvas.width / 2, canvas.height / 2);
  } else {
    // Table headers
    ctx.font = '16px monospace';
    ctx.textAlign = 'left';
    ctx.fillText('RANK', 80, 110);
    ctx.fillText('SCORE', 200, 110);
    ctx.fillText('DATE', 320, 110);

    // Draw line under headers
    ctx.strokeStyle = COLORS.text;
    ctx.beginPath();
    ctx.moveTo(60, 120);
    ctx.lineTo(canvas.width - 60, 120);
    ctx.stroke();

    // Entries
    leaderboard.forEach((entry, index) => {
      const y = 150 + (index * 30);

      // Highlight top 3
      if (index < 3) {
        ctx.fillStyle = COLORS.food;
      } else {
        ctx.fillStyle = COLORS.text;
      }

      ctx.textAlign = 'left';
      ctx.fillText(`${index + 1}.`, 80, y);
      ctx.fillText(entry.score.toString(), 200, y);

      // Format date
      const date = new Date(entry.date);
      const dateStr = date.toLocaleDateString();
      ctx.fillText(dateStr, 320, y);
    });
  }

  // Instructions
  ctx.fillStyle = COLORS.text;
  ctx.font = '14px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('Press C to Close', canvas.width / 2, canvas.height - 60);
  ctx.fillText('Press X to Clear Leaderboard', canvas.width / 2, canvas.height - 35);
}

function showLeaderboard() {
  showingLeaderboard = true;
}

function hideLeaderboard() {
  showingLeaderboard = false;
}
```

**Enhanced Input Handler:**
```javascript
function handleKeyPress(event) {
  const key = event.key;

  // Leaderboard modal input (priority)
  if (showingLeaderboard) {
    if (key.toLowerCase() === 'c' || key === 'Escape') {
      hideLeaderboard();
    }
    if (key.toLowerCase() === 'x') {
      if (clearLeaderboard()) {
        hideLeaderboard();
      }
    }
    return; // Don't process other inputs while modal open
  }

  // Rest of input handling...
}
```

**Enhanced Render Function:**
```javascript
function render() {
  // Normal rendering based on state
  switch (stateManager.currentState) {
    case GameStates.START:
      renderStartScreen();
      break;
    // ... other states
  }

  // Overlay leaderboard if showing
  if (showingLeaderboard) {
    renderLeaderboardModal();
  }
}
```

**Code Locations:**
- `game.js`: Leaderboard functions, modal rendering, enhanced input handling

**Key Considerations:**
- localStorage may be disabled or full - handle errors gracefully
- JSON parsing could fail - use try/catch
- Date formatting should be readable
- Top 3 scores highlighted for visual interest
- Confirmation prompt prevents accidental data loss
- Modal overlays current screen (doesn't change state)

## Dependencies
- [ ] Task 006 completed (game states and UI)

## Effort Estimate
- **Size:** M
- **Hours:** 10-12 hours
- **Parallel:** false (integrates with existing UI)

## Definition of Done
- [ ] Leaderboard saves to localStorage correctly
- [ ] Top 10 scores maintained (no more, no less)
- [ ] Scores sorted in descending order
- [ ] New scores insert at correct position
- [ ] Leaderboard modal displays correctly
- [ ] Modal accessible from start and game over screens
- [ ] High score displays on start screen
- [ ] Clear leaderboard works with confirmation
- [ ] Modal closes with C or ESC key
- [ ] Dates formatted readably
- [ ] Top 3 scores highlighted visually
- [ ] localStorage errors handled gracefully
- [ ] Code is well-commented
- [ ] Tested across browser sessions (persistence verified)
